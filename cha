FORM f_get_operation USING    ps_order TYPE viaufkst
                     CHANGING pv_vornr TYPE afvc-vornr.

  DATA: lv_aufpl TYPE afvc-aufpl,
        lv_aplzl TYPE afvc-aplzl,
        lv_objnr TYPE jest-objnr,
        lv_stat  TYPE jstat.

  "Step 1: Get first operation
  SELECT vornr aufpl aplzl objnr
    INTO (@pv_vornr, @lv_aufpl, @lv_aplzl, @lv_objnr)
    FROM afvc
   WHERE aufpl = @ps_order-aufpl
   ORDER BY aplzl
   UP TO 1 ROWS.
  ENDSELECT.

  "Step 2: Skip deleted operation (status I0013)
  IF sy-subrc = 0 AND lv_objnr IS NOT INITIAL.
    SELECT SINGLE stat
      INTO @lv_stat
      FROM jest
     WHERE objnr = @lv_objnr
       AND stat  = 'I0013'
       AND inact = ''.

    IF sy-subrc = 0.
      CLEAR pv_vornr.
    ENDIF.
  ENDIF.

ENDFORM.                    " f_get_operation