*---------------------------------------------------------------------*
* Update SAP status (CMXS)
*---------------------------------------------------------------------*
FORM f_send_cmx.
  DATA: lt_header  TYPE TABLE OF bapi_alm_order_headers_i,
        lt_status  TYPE TABLE OF bapi_alm_order_usrstat,
        lt_methods TYPE TABLE OF bapi_alm_order_method,
        lt_return  TYPE TABLE OF bapiret2,
        ls_status  TYPE bapi_alm_order_usrstat,
        ls_header  TYPE bapi_alm_order_headers_i,
        ls_method  TYPE bapi_alm_order_method,
        ls_return  TYPE bapiret2.

  LOOP AT gt_output ASSIGNING FIELD-SYMBOL(<ls_output_row>).

    CLEAR: lt_header, lt_status, lt_methods, lt_return.

    " Header (orderid is aufnr)
    CLEAR ls_header.
    ls_header-orderid = <ls_output_row>-aufnr.
    APPEND ls_header TO lt_header.

    " User status
    CLEAR ls_status.
    ls_status-objnr       = <ls_output_row>-aufnr.  " Order number as object
    ls_status-userstatus  = 'E0014'.                " Internal status CMXS
    APPEND ls_status TO lt_status.

    " Method for user status
    CLEAR ls_method.
    ls_method-refnumber  = '000001'.
    ls_method-objecttype = 'HEADER'.
    ls_method-method     = 'USERSTATUS'.
    ls_method-objectkey  = <ls_output_row>-aufnr.
    APPEND ls_method TO lt_methods.

    " Call BAPI
    CALL FUNCTION 'BAPI_ALM_ORDER_MAINTAIN'
      TABLES
        it_header     = lt_header
        it_methods    = lt_methods
        it_userstatus = lt_status
        return        = lt_return
      EXCEPTIONS
        OTHERS        = 1.

    IF sy-subrc <> 0.
      <ls_output_row>-msg = |BAPI call failed (SY-SUBRC={ sy-subrc })|.
    ELSE.
      READ TABLE lt_return INTO ls_return WITH KEY type = 'E'.
      IF sy-subrc = 0.
        <ls_output_row>-msg = ls_return-message.
        CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
      ELSE.
        <ls_output_row>-msg = 'CMXS status updated successfully'.
        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            wait = 'X'.
      ENDIF.
    ENDIF.

    " Always log
    PERFORM f_write_log USING <ls_output_row>-aufnr
                               <ls_output_row>-vornr
                               <ls_output_row>-werks
                               'CMXS'
                               <ls_output_row>-msg.

  ENDLOOP.

  COMMIT WORK.
ENDFORM.